<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonic Progression</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Tab Navigation -->
            <div class="tabs-navigation">
                <button @click="activeTab = 'training'" :class="['tab-btn', {active: activeTab === 'training'}]">Training</button>
                <button @click="activeTab = 'reference'" :class="['tab-btn', {active: activeTab === 'reference'}]">Reference</button>
            </div>

            <!-- Training Tab -->
            <div v-show="activeTab === 'training'" class="tab-content">
            <!-- User's Answer -->
            <div class="answer-row">
                <div class="answer-section" :class="resultClass">
                    <p>{{ userProgressionDisplay }}</p>
                </div>
                <button @click="undoChord" class="btn btn-small answer-undo">↶</button>
            </div>

            <!-- Chord Buttons grouped by scale degree -->
            <div class="chord-grid">
                <div 
                    class="degree-group"
                    v-for="group in chordGroups" 
                    :key="group.degree"
                >
                    <button
                        v-for="chord in group.chords"
                        :key="chord"
                        @click="guessChord(chord)"
                        class="btn btn-chord"
                    >
                        {{ chord }}
                    </button>
                </div>
            </div>

            <!-- Play Buttons (moved below chord buttons) -->
            <div class="button-group">
                <button @click="playProgression" class="btn btn-primary">▶ Play Progression</button>
            </div>

            <!-- Result Message (solution) -->
            <div v-if="resultMessage" class="result">
                {{ resultMessage }}
            </div>

            <!-- Chord Notes Display (stacked solution) -->
            <div v-if="chordNotesDisplay" class="chord-notes">
                {{ chordNotesDisplay }}
            </div>

            <!-- Repeat button under stacked chords -->
            <div v-if="chordNotesDisplay" class="button-group">
                <button @click="repeatProgression" class="btn btn-primary">↻ Repeat</button>
            </div>

            <!-- Score moved below resolution/solution box -->
            <div class="score-section">
                <p class="score">Score: {{ score }}/{{ total }}</p>
            </div>

            <!-- Bottom controls: settings and additional playback buttons -->
            <div class="bottom-controls">
                <!-- Options Section moved to bottom -->
                <div class="options-section">
                    <div class="control-group">
                        <label>Instrument:</label>
                        <select v-model="selectedInstrument">
                            <option>Piano</option>
                            <option>Bell</option>
                            <option>Violin</option>
                            <option>Flute</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Number of Chords:</label>
                        <select v-model="numChords">
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>Random</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Root Note Volume: {{ rootVolume }}%</label>
                        <input type="range" v-model.number="rootVolume" min="100" max="1000" step="10">
                    </div>

                    <div class="control-group">
                        <label>Playback Speed: {{ (playbackSpeed).toFixed(1) }}x</label>
                        <input type="range" v-model.number="playbackSpeed" min="0.5" max="4.0" step="0.1">
                    </div>

                    <div class="checkboxes">
                        <label>
                            <input type="checkbox" v-model="startOnTonic">
                            Start on Tonic
                        </label>
                        <label>
                            <input type="checkbox" v-model="useCommonOnly">
                            Common Progressions Only
                        </label>
                        <label>
                            <input type="checkbox" v-model="playAsArpeggio">
                            Play as Arpeggio
                        </label>
                    </div>
                </div>

                <div class="button-group bottom-button-group">
                    <button @click="playTonic" class="btn btn-secondary">♪ Play Tonic</button>
                </div>
            </div>
            </div> <!-- End Training Tab -->

            <!-- Reference Tab -->
            <div v-show="activeTab === 'reference'" class="tab-content reference-tab">
                <h2>Chord Reference</h2>
                
                <div class="reference-section">
                    <h3>Create New Progression</h3>
                    <button v-if="!creatingProgression" @click="startCreatingProgression" class="btn btn-primary">+ New Progression</button>
                    
                    <div v-if="creatingProgression" class="progression-builder">
                        <div class="builder-header">
                            <h4>Click chords to build your progression:</h4>
                            <div class="progression-display">
                                <span v-if="customProgression.length === 0" class="empty-state">No chords selected yet...</span>
                                <span v-for="(chord, idx) in customProgression" :key="idx" class="progression-chord">
                                    {{ chord }}
                                    <button @click="removeChordFromProgression(idx)" class="remove-btn">×</button>
                                </span>
                            </div>
                        </div>
                        
                        <div class="chords-buttons">
                            <button 
                                v-for="chord in referenceData.all_chords" 
                                :key="chord" 
                                @click="addChordToProgression(chord)"
                                class="btn btn-chord chord-select-btn"
                            >
                                {{ chord }}
                            </button>
                        </div>
                        
                        <div class="builder-actions">
                            <button @click="customProgression = []" class="btn btn-secondary">Clear</button>
                            <button @click="cancelCreatingProgression" class="btn btn-secondary">Cancel</button>
                            <button @click="saveCustomProgression" :disabled="customProgression.length === 0" class="btn btn-primary">Save Progression</button>
                        </div>
                    </div>
                </div>

                <div v-if="savedProgressions.length > 0" class="reference-section">
                    <h3>Your Saved Progressions</h3>
                    <div class="saved-progressions-list">
                        <div v-for="prog in savedProgressions" :key="prog.id" class="saved-progression-item">
                            <span class="progression-text">{{ prog.display }}</span>
                            <button @click="deleteSavedProgression(prog.id)" class="btn btn-small btn-danger">Delete</button>
                        </div>
                    </div>
                </div>

                <div class="reference-section">
                    <h3>All Available Chords</h3>
                    <p class="section-help">Click to deactivate/activate chords for progression generation</p>
                    <div class="chord-grid reference-chord-grid">
                        <div 
                            class="degree-group"
                            v-for="group in chordGroups" 
                            :key="group.degree"
                        >
                            <button
                                v-for="chord in group.chords"
                                :key="chord"
                                @click="toggleChordDeactivation(chord)"
                                :class="['btn', 'btn-chord', 'chord-toggle', {deactivated: isChordDeactivated(chord)}]"
                            >
                                {{ chord }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="reference-section">
                    <h3>Common Progressions</h3>
                    <ul class="progressions-list">
                        <li v-for="(prog, idx) in referenceData.common_progressions" :key="idx">{{ prog }}</li>
                    </ul>
                </div>

                <div class="reference-section">
                    <h3>Common Chord Movements</h3>
                    <div class="movements-list">
                        <div v-for="move in referenceData.chord_movements" :key="move" class="movement-item">{{ move }}</div>
                    </div>
                </div>
            </div> <!-- End Reference Tab -->

            <!-- Exit Button -->
            <button @click="exit" class="btn btn-danger">Exit</button>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
